(self["webpackChunkthundersdata_frontend"]=self["webpackChunkthundersdata_frontend"]||[]).push([[3769],{31792:function(e,n,t){"use strict";t.r(n);var a=t(59496),o=t(19111),r=t(73376),l=a.memo((e=>{e.demos;return a.createElement(a.Fragment,null,a.createElement("div",{className:"markdown"},a.createElement("h1",{id:"rn-\u5e94\u7528\u5f00\u53d1\u5e38\u89c1\u95ee\u9898"},a.createElement(o.AnchorLink,{to:"#rn-\u5e94\u7528\u5f00\u53d1\u5e38\u89c1\u95ee\u9898","aria-hidden":"true",tabIndex:-1},a.createElement("span",{className:"icon icon-link"})),"RN \u5e94\u7528\u5f00\u53d1\u5e38\u89c1\u95ee\u9898"),a.createElement("h2",{id:"1-\u81ea\u5b9a\u4e49\u56fe\u6807"},a.createElement(o.AnchorLink,{to:"#1-\u81ea\u5b9a\u4e49\u56fe\u6807","aria-hidden":"true",tabIndex:-1},a.createElement("span",{className:"icon icon-link"})),"1. \u81ea\u5b9a\u4e49\u56fe\u6807"),a.createElement("h2",{id:"2-\u96c6\u6210\u6781\u5149\u63a8\u9001"},a.createElement(o.AnchorLink,{to:"#2-\u96c6\u6210\u6781\u5149\u63a8\u9001","aria-hidden":"true",tabIndex:-1},a.createElement("span",{className:"icon icon-link"})),"2. \u96c6\u6210\u6781\u5149\u63a8\u9001"),a.createElement("h2",{id:"3-\u96c6\u6210\u70ed\u66f4\u65b0"},a.createElement(o.AnchorLink,{to:"#3-\u96c6\u6210\u70ed\u66f4\u65b0","aria-hidden":"true",tabIndex:-1},a.createElement("span",{className:"icon icon-link"})),"3. \u96c6\u6210\u70ed\u66f4\u65b0"),a.createElement("h3",{id:"\u5b89\u88c5\u4e0e\u6ce8\u518c-codepush"},a.createElement(o.AnchorLink,{to:"#\u5b89\u88c5\u4e0e\u6ce8\u518c-codepush","aria-hidden":"true",tabIndex:-1},a.createElement("span",{className:"icon icon-link"})),"\u5b89\u88c5\u4e0e\u6ce8\u518c CodePush"),a.createElement("ul",null,a.createElement("li",null,"\u5728\u7ec8\u7aef\u8f93\u5165",a.createElement("code",null,"npm install -g code-push-cli")),a.createElement("li",null,"\u5b89\u88c5\u5b8c\u6bd5\u540e\uff0c\u8f93\u5165",a.createElement("code",null,"code-push -v"),"\u67e5\u770b\u7248\u672c\uff0c\u5982\u770b\u5230\u7248\u672c\u53f7\u5219\u4ee3\u8868\u5b89\u88c5\u6210\u529f"),a.createElement("li",null,"\u5728\u7ec8\u7aef\u8f93\u5165 ",a.createElement("code",null,"code-push register"),"\uff0c\u4f1a\u5728\u6d4f\u89c8\u5668\u81ea\u52a8\u6253\u5f00\u6ce8\u518c\u9875\u9762\u8ba9\u4f60\u9009\u62e9\u6388\u6743\u8d26\u53f7\uff0c\u6388\u6743\u901a\u8fc7\u4e4b\u540e CodePush \u4f1a\u544a\u8bc9\u4f60 access key\uff0c\u590d\u5236\u6b64\u53ef\u4ee5\u5230\u7ec8\u7aef\u5373\u53ef\u5b8c\u6210\u6ce8\u518c"),a.createElement("li",null,"\u7136\u540e\u8f93\u5165",a.createElement("code",null,"code-push login"),"\u8fdb\u884c\u767b\u5f55\uff0c\u767b\u5f55\u6210\u529f\u4f1a\u63d0\u793a successfully logged-in"),a.createElement("li",null,"\u4e3a\u4e86\u8ba9 CodePush \u670d\u52a1\u5668\u77e5\u9053\u4f60\u7684 app\uff0c\u6211\u4eec\u9700\u8981\u5411\u5b83\u6ce8\u518c app\uff1a\u5728\u7ec8\u7aef\u8f93\u5165",a.createElement("code",null,"code-push app add <appName> <os> react-native"),"\uff0c\u5982: ",a.createElement("code",null,"code-push app add animalHusbandryCollectorApp android react-native"),"\u3002\u4e00\u822c",a.createElement("code",null,"appName"),"\u5c31\u662f\u9879\u76ee\u4e2d",a.createElement("code",null,"app.json"),"\u6587\u4ef6\u4e2d\u7684",a.createElement("code",null,"name"),"\u3002\u6ce8\u518c\u5b8c\u6210\u4e4b\u540e\u4f1a\u8fd4\u56de\u4e00\u5957 ",a.createElement("code",null,"deploymentKey"),"\uff0c\u8bf7\u8bb0\u5f55\u4e0b\u8be5 key\uff0c\u4f1a\u5728\u540e\u9762\u6b65\u9aa4\u4e2d\u7528\u5230\u3002\u5982\u679c android \u548c iOS \u90fd\u9700\u8981\u70ed\u66f4\u65b0\u529f\u80fd\uff0c\u9700\u8981\u5206\u522b\u751f\u6210\u4e00\u5957 key")),a.createElement(r.Z,{code:"code-push app add animalHusbandryCollectorApp-android android react-native\ncode-push app add animalHusbandryCollectorApp-ios ios react-native",lang:"code"}),a.createElement("h3",{id:"\u9879\u76ee\u4e2d\u5b89\u88c5\u4f9d\u8d56"},a.createElement(o.AnchorLink,{to:"#\u9879\u76ee\u4e2d\u5b89\u88c5\u4f9d\u8d56","aria-hidden":"true",tabIndex:-1},a.createElement("span",{className:"icon icon-link"})),"\u9879\u76ee\u4e2d\u5b89\u88c5\u4f9d\u8d56"),a.createElement(r.Z,{code:"yarn add react-native-code-push",lang:"code"}),a.createElement("h3",{id:"android-\u914d\u7f6e"},a.createElement(o.AnchorLink,{to:"#android-\u914d\u7f6e","aria-hidden":"true",tabIndex:-1},a.createElement("span",{className:"icon icon-link"})),"Android \u914d\u7f6e"),a.createElement("ul",null,a.createElement("li",null,a.createElement("code",null,"android/app/build.gradle\u3002\u628a\u4e0a\u9762\u751f\u6210\u7684 android \u7684 deploymentKey \u653e\u5230\u4e0b\u9762 buildTypes \u4e2d"))),a.createElement(r.Z,{code:"apply from: \"../../node_modules/react-native/react.gradle\"\napply from: \"../../node_modules/react-native-code-push/android/codepush.gradle\" // <- \u6dfb\u52a0\u8fd9\u884c\n\nandroid {\n   ...\n    signingConfigs {\n        debug {\n            storeFile file('debug.keystore')\n            storePassword 'android'\n            keyAlias 'androiddebugkey'\n            keyPassword 'android'\n        }\n        releaseStaging {\n            storeFile file('staging.keystore')\n            storePassword 'android'\n            keyAlias 'androidstagingkey'\n            keyPassword 'android'\n        }\n        release {\n            if (project.hasProperty('RELEASE_STORE_FILE')) {\n                storeFile file(RELEASE_STORE_FILE)\n                storePassword RELEASE_STORE_PASSWORD\n                keyAlias RELEASE_KEY_ALIAS\n                keyPassword RELEASE_KEY_PASSWORD\n            }\n        }\n    }\n\n    buildTypes {\n        debug {\n            ...\n            // Note: CodePush updates should not be tested in Debug mode as they are overriden by the RN packager. However, because CodePush checks for updates in all modes, we must supply a key.\n            resValue \"string\", \"CodePushDeploymentKey\", '\"\"'\n            ...\n        }\n\n        releaseStaging.initWith(release)\n        releaseStaging {\n            ...\n            signingConfig signingConfigs.releaseStaging\n            resValue \"string\", \"CodePushDeploymentKey\", '\"<INSERT_STAGING_KEY>\"'\n\n            // Note: It is a good idea to provide matchingFallbacks for the new buildType you create to prevent build issues\n            // Add the following line if not already there\n            matchingFallbacks = ['release']\n            ...\n        }\n\n        release {\n            ...\n            resValue \"string\", \"CodePushDeploymentKey\", '\"<INSERT_PRODUCTION_KEY>\"'\n            ...\n        }\n    }\n    ...\n}",lang:"code"}),a.createElement("ul",null,a.createElement("li",null,a.createElement("code",null,"android/settings.gradle"))),a.createElement(r.Z,{code:"include ':app', ':react-native-code-push'\nproject(':react-native-code-push').projectDir = new File(rootProject.projectDir, '../node_modules/react-native-code-push/android/app')",lang:"code"}),a.createElement("ul",null,a.createElement("li",null,a.createElement("code",null,"MainApplication.java"))),a.createElement(r.Z,{code:"import com.microsoft.codepush.react.CodePush;\n\nprivate final ReactNativeHost mReactNativeHost = new ReactNativeHost(this) {\n  ...\n  @Override\n  protected String getJSBundleFile() {\n    return CodePush.getJSBundleFile();\n  }\n};",lang:"java"}),a.createElement("h3",{id:"ios-\u914d\u7f6e"},a.createElement(o.AnchorLink,{to:"#ios-\u914d\u7f6e","aria-hidden":"true",tabIndex:-1},a.createElement("span",{className:"icon icon-link"})),"IOS \u914d\u7f6e"),a.createElement(r.Z,{code:"cd ios && pod install",lang:"code"}),a.createElement("ul",null,a.createElement("li",null,a.createElement("code",null,"AppDelegate.m"))),a.createElement(r.Z,{code:'#import <CodePush/CodePush.h>\n\n// \u628a\u4e0b\u9762\u8fd9\u884c\u4ee3\u7801\uff1a\nreturn [[NSBundle mainBundle] URLForResource:@"main" withExtension:@"jsbundle"];\n// \u6539\u6210\uff1a\nreturn [CodePush bundleURL];\n\n// \u6700\u540e\u7684sourceURLForBridge\u65b9\u6cd5\u5982\u4e0b\uff1a\n- (NSURL *)sourceURLForBridge:(RCTBridge *)bridge\n{\n  #if DEBUG\n    return [[RCTBundleURLProvider sharedSettings] jsBundleURLForBundleRoot:@"index" fallbackResource:nil];\n  #else\n    return [CodePush bundleURL];\n  #endif\n}',lang:"code"}),a.createElement("ul",null,a.createElement("li",null,"Info.plist \u6267\u884c\u547d\u4ee4\uff1a",a.createElement("code",null,"appcenter codepush deployment list -a <ownerName>/<appName> -k"),"\u67e5\u770b server \u4e0a\u7684 deployment key \u5728",a.createElement("code",null,"Info.plist"),"\u6587\u4ef6\u91cc\u9762\u65b0\u5efa\u4e00\u4e2a\u952e\u503c\u5bf9\uff1a")),a.createElement(r.Z,{code:"<key>CodePushDeploymentKey</key>\n<string>Your Deployment Key</string>",lang:"code"}),a.createElement("ul",null,a.createElement("li",null,"\u6253\u5f00 xcode\uff0c\u9009\u4e2d\u81ea\u5df1\u7684\u9879\u76ee\uff0c\u9009\u4e2d",a.createElement("strong",null,"project"),"\u4e0b\u7684\u9879\u76ee\u540d\u79f0\uff0c\u9009\u62e9",a.createElement("code",null,"Info"),"\u6807\u7b7e\u9875\uff0c\u70b9\u51fb",a.createElement("code",null,"Configurations"),"\u4e0b\u7684\u52a0\u53f7\uff0c\u9009\u62e9",a.createElement("code",null,'Duplicate "Release" Configuration')," \u547d\u540d\u4e3a",a.createElement("code",null,"Staging"),".")),a.createElement("center",null,a.createElement("img",{src:"https://td-dev-public.oss-cn-hangzhou.aliyuncs.com/maoyes-app/1644829195776339205.png",alt:"\u6570\u7ec4\u63d2\u5165",width:400})),a.createElement("ul",null,a.createElement("li",null,"\u9009\u62e9",a.createElement("code",null,"Build Settings"),"\u6807\u7b7e\u9875\uff0c\u70b9\u51fb\u52a0\u53f7\uff0c\u9009\u62e9",a.createElement("code",null,"Add User Defined Setting"),"\u7528.xcodeproj \u6253\u5f00\u9879\u76ee\uff0c\u5148\u628a Debug/Release/Staging \u7684\u503c\u914d\u7f6e\u597d\uff1a Debug: ",a.createElement("code",null,"$(BUILD_DIR)/$(CONFIGURATION)$(EFFECTIVE_PLATFORM_NAME)")," Release: ",a.createElement("code",null,"$(BUILD_DIR)/$(CONFIGURATION)$(EFFECTIVE_PLATFORM_NAME)")," Staging: ",a.createElement("code",null,"$(BUILD_DIR)/Release$(EFFECTIVE_PLATFORM_NAME)")," \u7136\u540e\u628a\u914d\u7f6e\u540d\u79f0\u6539\u6210\uff1a",a.createElement("code",null,"CONFIGURATION_BUILD_DIR"),"\uff0c\u7136\u540e\u518d\u5207\u6362\u56de.xcworkspace \u6253\u5f00\u9879\u76ee")),a.createElement("center",null,a.createElement("img",{src:"https://td-dev-public.oss-cn-hangzhou.aliyuncs.com/maoyes-app/1644829210496443837.png",alt:"\u6570\u7ec4\u63d2\u5165",width:400})),a.createElement("ul",null,a.createElement("li",null,a.createElement("p",null,"\u518d\u6b21\u9009\u62e9",a.createElement("code",null,"Add User Defined Setting"),"\uff0c\u8f93\u5165",a.createElement("code",null,"CODEPUSH_KEY"),"\uff0c\u901a\u8fc7\u547d\u4ee4",a.createElement("code",null,"appcenter codepush deployment list -a <ownerName>/<appName> -k"),"\u628a",a.createElement("code",null,"Staging"),"\u548c",a.createElement("code",null,"Production"),"\u7684 deployment key \u5206\u522b\u586b\u5230",a.createElement("code",null,"CODEPUSH_KEY"),"\u4e0b\u5339\u914d\u7684\u5c5e\u6027\u91cc\u3002")),a.createElement("li",null,a.createElement("p",null,"\u6253\u5f00",a.createElement("code",null,"Info.plist"),"\uff0c\u628a\u4e4b\u524d\u7684",a.createElement("code",null,"CodePushDeploymentKey"),"\u7684\u503c\u6539\u6210",a.createElement("code",null,"$(CODEPUSH_KEY)"))),a.createElement("li",null,a.createElement("p",null,"\u91cd\u65b0\u8fd0\u884c",a.createElement("code",null,"pod install"))),a.createElement("li",null,a.createElement("p",null,"\u8fd0\u884c\u4ee3\u7801\uff0c\u80fd\u591f\u6b63\u5e38\u542f\u52a8\u6a21\u62df\u5668\uff0c\u5c31\u8868\u793a\u96c6\u6210\u6210\u529f"))),a.createElement("h3",{id:"\u4ee3\u7801\u4e2d\u4f7f\u7528"},a.createElement(o.AnchorLink,{to:"#\u4ee3\u7801\u4e2d\u4f7f\u7528","aria-hidden":"true",tabIndex:-1},a.createElement("span",{className:"icon icon-link"})),"\u4ee3\u7801\u4e2d\u4f7f\u7528"),a.createElement("ol",null,a.createElement("li",null,"\u5728\u9879\u76ee\u4e2d\u589e\u52a0\u6587\u4ef6\uff08\u53ef\u4ee5\u76f4\u63a5\u62f7\u8d1d\uff09\uff1a",a.createElement("code",null,"scripts/codePush/index.js"))),a.createElement(r.Z,{code:"'use strict';\n\nconst { makePush } = require('./makePush');\nconst inquirer = require('inquirer');\n\nconst ENV_PARAMS = {\n  message: '\u8bf7\u9009\u62e9\u60a8\u8981\u90e8\u7f72\u73af\u5883',\n  type: 'list',\n  name: 'environment',\n  items: {\n    1: 'Production',\n    2: 'Staging'\n  },\n  choices: ['Staging', 'Production']\n};\n\nconst PLATFORM_PARAMS = {\n  message: '\u8bf7\u9009\u62e9\u60a8\u8981\u90e8\u7f72\u7684\u5e73\u53f0',\n  type: 'list',\n  name: 'platform',\n  choices: ['both', 'android', 'ios'],\n  default: 'both'\n};\n\nconst VERSION_PARAMS = {\n  name: 'version',\n  type: 'input',\n  message: '\u8bf7\u8f93\u5165\u8981\u66f4\u65b0\u7684\u76ee\u6807\u7248\u672c\u53f7'\n};\n\nconst DES_PARAMS = {\n  name: 'description',\n  type: 'editor',\n  message: '\u8bf7\u8f93\u5165\u672c\u6b21\u4fee\u6539\u7684\u63cf\u8ff0'\n};\n\nconst MANDATORY_PARAMS = {\n  message: '\u672c\u6b21\u66f4\u65b0\u662f\u5426\u4e3a\u5f3a\u5236\u66f4\u65b0',\n  type: 'list',\n  name: 'mandatory',\n  choices: ['true', 'false'],\n  default: 'false',\n};\n\nconst QUESTIONS = [ENV_PARAMS, PLATFORM_PARAMS, DES_PARAMS, VERSION_PARAMS, MANDATORY_PARAMS];\n\nfunction main (){\n  inquirer.prompt(QUESTIONS).then(option => {\n    const { description, environment, platform, version, mandatory } = option;\n    if (!description) {\n      console.error('\u4f60\u6ca1\u6709\u8f93\u5165\u6539\u52a8\u63cf\u8ff0');\n      process.exit(1);\n    }\n    makePush({\n      environment,\n      platform,\n      version,\n      description,\n      mandatory,\n    });\n  });\n}\n\nmain();",lang:"code"}),a.createElement("ol",{start:2},a.createElement("li",null,"\u5728\u9879\u76ee\u4e2d\u589e\u52a0\u6587\u4ef6\uff1a",a.createElement("code",null,"scripts/codePush/makePush.js"))),a.createElement("p",null,a.createElement("code",null,"\u6ce8\u610f\uff1a\u9700\u8981\u628a\u4e0b\u9762\u7684\u7684\u5305\u7684\u540d\u5b57\u7ed9\u66ff\u6362\u6389 thundersdata/rn-template-android ---\x3e ownerName/\u5728\u4e4b\u524d\u6b65\u9aa4\u6ce8\u518c\u7684\u5bf9\u5e94\u5e73\u53f0\u7684app\u7684\u540d\u5b57\uff0c\u5982\u679candroid\u548cios\u90fd\u9700\u8981\u70ed\u66f4\u65b0\uff0c\u5219\u90fd\u8981\u66ff\u6362 ")),a.createElement(r.Z,{code:'\'use strict\';\nconst shell = require(\'shelljs\');\n\nfunction makePush({ environment, platform, description, mandatory, version }) {\n  let androidCmd = `appcenter codepush release-react -a thundersdata/rn-template-android -d ${environment} --description "${description}" -m "${mandatory}"`;\n  let iosCmd = `appcenter codepush release-react -a thundersdata/rn-template-ios -d ${environment} --description "${description}" -m "${mandatory}"`;\n  if (version) {\n    androidCmd += ` -t "${version}"`;\n    iosCmd += ` -t "${version}"`;\n  }\n  let finalCmd = \'\';\n  if (platform === \'both\') {\n    finalCmd = `${androidCmd} && ${iosCmd}`;\n  } else if (platform === \'android\') {\n    finalCmd = androidCmd;\n  } else {\n    finalCmd = iosCmd;\n  }\n\n  shell.exec(finalCmd);\n}\n\nmodule.exports = {\n  makePush,\n};',lang:"code"}),a.createElement("ol",{start:3},a.createElement("li",null,"\u5728\u9879\u76ee\u4e2d\u6dfb\u52a0\u6587\u4ef6\uff1a",a.createElement("code",null,"hooks/useCodePush.ts"))),a.createElement(r.Z,{code:"import codePush, { DownloadProgress } from 'react-native-code-push';\nimport { useMemoizedFn, useSafeState } from '@td-design/rn-hooks';\nimport { useRef } from 'react';\nimport { Modal, Toast } from '@td-design/react-native';\n\nexport function useCodePush() {\n  const key = useRef(-1);\n\n  const [progress, setProgress] = useSafeState<string>();\n\n  // eslint-disable-next-line complexity\n  const codePushStatusDidChange = async (syncStatus: codePush.SyncStatus) => {\n    switch (syncStatus) {\n      case codePush.SyncStatus.CHECKING_FOR_UPDATE:\n        // 0 - \u6b63\u5728\u67e5\u8be2CodePush\u670d\u52a1\u5668\u4ee5\u8fdb\u884c\u66f4\u65b0\u3002\n        console.info('[CodePush] Checking for update.');\n        break;\n      case codePush.SyncStatus.AWAITING_USER_ACTION:\n        // 1 - \u6709\u53ef\u7528\u7684\u66f4\u65b0\uff0c\u5e76\u4e14\u5411\u6700\u7ec8\u7528\u6237\u663e\u793a\u4e86\u4e00\u4e2a\u786e\u8ba4\u5bf9\u8bdd\u6846\u3002\uff08\u4ec5\u5728updateDialog\u4f7f\u7528\u65f6\u9002\u7528\uff09\n        console.info('[CodePush] Awaiting user action.');\n        break;\n      case codePush.SyncStatus.DOWNLOADING_PACKAGE:\n        // 2 - \u6b63\u5728\u4eceCodePush\u670d\u52a1\u5668\u4e0b\u8f7d\u53ef\u7528\u66f4\u65b0\u3002\n        console.info('[CodePush] Downloading package.');\n        break;\n      case codePush.SyncStatus.INSTALLING_UPDATE:\n        // 3 - \u5df2\u4e0b\u8f7d\u4e00\u4e2a\u53ef\u7528\u7684\u66f4\u65b0\uff0c\u5e76\u5c06\u5176\u5b89\u88c5\u3002\n        console.info('[CodePush] Installing update.');\n        break;\n      case codePush.SyncStatus.UP_TO_DATE:\n        // 4 - \u5e94\u7528\u7a0b\u5e8f\u5df2\u914d\u7f6e\u7684\u90e8\u7f72\u5b8c\u5168\u6700\u65b0\u3002\n        console.info('[CodePush] App is up to date.');\n        break;\n      case codePush.SyncStatus.UPDATE_IGNORED:\n        // 5 \u8be5\u5e94\u7528\u7a0b\u5e8f\u5177\u6709\u53ef\u9009\u66f4\u65b0\uff0c\u6700\u7ec8\u7528\u6237\u9009\u62e9\u5ffd\u7565\u8be5\u66f4\u65b0\u3002\uff08\u4ec5\u5728updateDialog\u4f7f\u7528\u65f6\u9002\u7528\uff09\n        console.info('[CodePush] User cancelled the update.');\n        break;\n      case codePush.SyncStatus.UPDATE_INSTALLED:\n        // 6 - \u5b89\u88c5\u4e86\u4e00\u4e2a\u53ef\u7528\u7684\u66f4\u65b0\uff0c\u5b83\u5c06\u6839\u636e SyncOptions \u4e2d\u7684 InstallMode\u6307\u5b9a\u5728 syncStatusChangedCallback \u51fd\u6570\u8fd4\u56de\u540e\u7acb\u5373\u6216\u5728\u4e0b\u6b21\u5e94\u7528\u6062\u590d/\u91cd\u65b0\u542f\u52a8\u65f6\u7acb\u5373\u8fd0\u884c\u3002\n        console.info('[CodePush] Installed update.');\n        break;\n      case codePush.SyncStatus.SYNC_IN_PROGRESS:\n        // 7 - \u6b63\u5728\u6267\u884c\u7684 sync \u64cd\u4f5c\n        console.info('[CodePush] Sync already in progress.');\n        break;\n      case codePush.SyncStatus.UNKNOWN_ERROR:\n        // -1 - \u540c\u6b65\u64cd\u4f5c\u9047\u5230\u672a\u77e5\u9519\u8bef\u3002\n        console.info('[CodePush] An unknown error occurred.');\n        break;\n    }\n  };\n\n  const codePushDownloadDidProgress = (progress: DownloadProgress) => {\n    const curPercent = ((progress.receivedBytes / progress.totalBytes) * 100).toFixed(0);\n    console.info('[CodePushUtils] Downloading Progress', `${curPercent}%`);\n    setProgress(`${curPercent}%`);\n  };\n\n  const syncImmediate = async () => {\n    codePush.sync(\n      {\n        updateDialog: {\n          // \u662f\u5426\u663e\u793a\u66f4\u65b0\u63cf\u8ff0\n          appendReleaseDescription: true,\n          // \u66f4\u65b0\u63cf\u8ff0\u7684\u524d\u7f00\u3002 \u9ed8\u8ba4\u4e3a\"Description\"\n          descriptionPrefix: '\\n\\n\u66f4\u65b0\u5185\u5bb9\uff1a\\n',\n          // \u5f3a\u5236\u66f4\u65b0\u6309\u94ae\u6587\u5b57\uff0c\u9ed8\u8ba4\u4e3acontinue\n          mandatoryContinueButtonLabel: '\u7acb\u5373\u66f4\u65b0',\n          // \u5f3a\u5236\u66f4\u65b0\u65f6\u7684\u4fe1\u606f. \u9ed8\u8ba4\u4e3a\"An update is available that must be installed.\"\n          mandatoryUpdateMessage: '\u5fc5\u987b\u66f4\u65b0\u540e\u624d\u80fd\u4f7f\u7528',\n          // \u975e\u5f3a\u5236\u66f4\u65b0\u65f6\uff0c\u6309\u94ae\u6587\u5b57,\u9ed8\u8ba4\u4e3a\"ignore\"\n          optionalIgnoreButtonLabel: '\u7a0d\u540e',\n          // \u975e\u5f3a\u5236\u66f4\u65b0\u65f6\uff0c\u786e\u8ba4\u6309\u94ae\u6587\u5b57. \u9ed8\u8ba4\u4e3a\"Install\"\n          optionalInstallButtonLabel: '\u540e\u53f0\u66f4\u65b0',\n          // \u975e\u5f3a\u5236\u66f4\u65b0\u65f6\uff0c\u68c0\u67e5\u5230\u66f4\u65b0\u7684\u6d88\u606f\u6587\u672c\n          optionalUpdateMessage: '\u6709\u65b0\u7248\u672c\u4e86\uff0c\u662f\u5426\u66f4\u65b0\uff1f',\n          // Alert\u7a97\u53e3\u7684\u6807\u9898\n          title: '\u66f4\u65b0',\n        },\n        installMode: codePush.InstallMode.IMMEDIATE,\n      },\n      codePushStatusDidChange,\n      codePushDownloadDidProgress,\n    );\n  };\n\n  /** \u4e2a\u4eba\u4e2d\u5fc3\u9875\u9762\u7528 */\n  const checkForUpdate = async () => {\n    key.current = Toast.submitting({ content: '\u68c0\u67e5\u4e2d...' });\n    const update = await codePush.checkForUpdate();\n    Toast.remove(key.current);\n    if (!update) {\n      Modal.alert({\n        title: '\u63d0\u793a',\n        content: '\u5f53\u524d\u7248\u672c\u6ca1\u6709\u53d1\u73b0\u9700\u8981\u5b89\u88c5\u7684\u66f4\u65b0',\n      });\n    } else {\n      syncImmediate();\n    }\n  };\n\n  /** app\u542f\u52a8\u65f6\u4e0d\u9700\u8981\u5f39\u7a97\u63d0\u793a */\n  const checkForUpdateWithoutMessage = async () => {\n    const update = await codePush.checkForUpdate();\n    if (!update) {\n      // \u5982\u679c\u6ca1\u6709\u5728app\u542f\u52a8\u65f6\u8c03\u7528sync\uff0c\u5219\u9700\u8981\u663e\u5f0f\u8c03\u7528notifyAppReady\uff0c\u5426\u5219\u63d2\u4ef6\u5c06\u8ba4\u4e3a\u66f4\u65b0\u5931\u8d25\u5e76\u56de\u6eda\u56de\u4ee5\u524d\u7248\u672c\n      codePush.notifyAppReady();\n    } else {\n      syncImmediate();\n    }\n  };\n\n  return {\n    progress,\n    checkForUpdate: useMemoizedFn(checkForUpdate),\n    checkForUpdateWithoutMessage: useMemoizedFn(checkForUpdateWithoutMessage),\n    sync: syncImmediate,\n  };\n}",lang:"code"}),a.createElement("ol",{start:4},a.createElement("li",null,a.createElement("code",null,"\u7531\u4e8e\u70ed\u66f4\u65b0\u65f6\u6211\u4eec\u53ea\u80fd\u9488\u5bf9\u7279\u5b9a\u7684\u7248\u672c\u8fdb\u884c\u70ed\u66f4\u65b0\uff0c\u6240\u4ee5\u4e3a\u4e86\u4fdd\u8bc1\u540e\u7eed\u7528\u6237\u624b\u673a\u4e0a app \u7248\u672c\u7684\u4e00\u81f4\u6027\uff0c\u6211\u4eec\u63a8\u8350\u4f7f\u7528\u5f3a\u66f4\u65b0\u548c\u70ed\u66f4\u65b0\u76f8\u7ed3\u5408\u7684\u65b9\u5f0f\u3002\u5f53\u6709\u7248\u672c\u66f4\u65b0\u65f6\uff0c\u6211\u4eec\u63a8\u8350\u4f7f\u7528\u5f3a\u66f4\u65b0\u529f\u80fd\uff0c\u5f53\u9700\u8981\u5bf9\u67d0\u4e2a\u7248\u672c\u8fdb\u884c bug \u4fee\u590d\u65f6\uff0c\u6211\u4eec\u63a8\u8350\u4f7f\u7528\u70ed\u66f4\u65b0\u529f\u80fd\u3002"))),a.createElement("p",null,a.createElement("code",null,"\u6ce8\u610f\uff1a\u70ed\u66f4\u65b0\u8981\u6c42app\u7248\u672c\u5fc5\u987b\u662f\u4e09\u6bb5\u5f0f\u7684\uff0c\u5982: 1.1.0\u3002")),a.createElement("p",null,"\u6dfb\u52a0\u6587\u4ef6\uff1a",a.createElement("code",null,"hooks/useCheckUpdate.ts")),a.createElement(r.Z,{code:"import { useRef } from 'react';\nimport { helpers, Image, Modal, Toast } from '@td-design/react-native';\nimport { ForceUpdateEnum } from 'enums';\nimport RNFetchBlob from 'rn-fetch-blob';\nimport { PERMISSIONS, request } from 'react-native-permissions';\nimport { useCustomRequest } from './useCustomRequest';\nimport { useToast } from './useToast';\nimport { useCodePush } from './useCodePush';\nimport { Linking, Platform } from 'react-native';\n\nconst { px } = helpers;\n\nexport function useCheckUpdate(showMessage = false) {\n  const { toastFail } = useToast();\n  const { checkForUpdate, checkForUpdateWithoutMessage } = useCodePush();\n\n  const key = useRef(-1);\n\n  const appUpdate = async (androidDownloadUrl: string, appStoreUrl: string, version: string) => {\n    if (Platform.OS === 'android') {\n      const result = await request(PERMISSIONS.ANDROID.WRITE_EXTERNAL_STORAGE);\n      if (result !== 'granted') {\n        toastFail('\u8bf7\u6388\u6743APP\u4e0b\u8f7d\u6587\u4ef6\u7684\u6743\u9650');\n        return;\n      }\n      key.current = Toast.submitting({ content: '\u4e0b\u8f7d\u4e2d...' });\n      const downloadPath = RNFetchBlob.fs.dirs.DownloadDir + `/animalHusbandryCollectorApp-${version}.apk`;\n      const android = RNFetchBlob.android;\n      RNFetchBlob.config({\n        addAndroidDownloads: {\n          // \u8c03\u8d77\u539f\u751f\u4e0b\u8f7d\u7ba1\u7406\n          useDownloadManager: true,\n          // \u4e0b\u8f7d\u7684\u5b89\u88c5\u5305\u4fdd\u5b58\u7684\u540d\u5b57\n          title: `animalHusbandryCollectorApp-${version}.apk`,\n          // \u4e0b\u8f7d\u65f6\u5019\u9876\u90e8\u901a\u77e5\u680f\u7684\u63cf\u8ff0\n          description: '\u4e0b\u8f7d\u5b8c\u6210\u4e4b\u540e\u5c06\u4f1a\u81ea\u52a8\u5b89\u88c5',\n          // \u4e0b\u8f7d\u7684\u6587\u4ef6\u683c\u5f0f\n          mime: 'application/vnd.android.package-archive',\n          // \u4e0b\u8f7d\u5b8c\u6210\u4e4b\u540e\u626b\u63cf\u4e0b\u8f7d\u7684\u6587\u4ef6\n          mediaScannable: true,\n          // \u901a\u77e5\u680f\u663e\u793a\u4e0b\u8f7d\u60c5\u51b5\n          notification: true,\n          // \u4e0b\u8f7d\u5730\u5740\n          path: downloadPath,\n        },\n      })\n        .fetch('GET', androidDownloadUrl)\n        .then(res => {\n          android.actionViewIntent(res.path(), 'application/vnd.android.package-archive');\n        })\n        .catch(() => {\n          toastFail('\u4e0b\u8f7d\u5931\u8d25');\n        })\n        .finally(() => {\n          Toast.remove(key.current);\n        });\n    } else {\n      Linking.canOpenURL(appStoreUrl)\n        .then(supported => {\n          if (!supported) {\n            console.warn('\u627e\u4e0d\u5230\u5bf9\u5e94\u7684\u5e94\u7528');\n            return false;\n          }\n          return Linking.openURL(appStoreUrl);\n        })\n        .catch(err => {\n          console.error('\u8df3\u8f6c\u5230APP_STORE\u5931\u8d25\uff0c\u5931\u8d25\u539f\u56e0\uff1a', err);\n        });\n    }\n  };\n\n  /**\n   * \u6839\u636e\u7248\u672c\u53f7\u5bf9\u6bd4\u662f\u5426\u9700\u8981\u5f3a\u5236\u66f4\u65b0\uff0c\u9ed8\u8ba4\u7248\u672c\u53f7\u4e3a\u4e09\u6bb5 \u5982\uff1a1.2.3\n   * \u548c\u540e\u7aef\u7ea6\u5b9a\uff1a\u7b2c\u4e00\u6bb5\u548c\u7b2c\u4e8c\u6bb5\u4e3a\u5f3a\u5236\u66f4\u65b0\uff0c\u7b2c\u4e09\u6bb5\u4e3a\u975e\u5f3a\u5236\u66f4\u65b0\n   * \u5982\u679c\u662f\u975e\u5f3a\u5236\u66f4\u65b0\u7684\u8bdd\uff0c\u8d70\u70ed\u66f4\u65b0\u529f\u80fd\n   */\n  const { run: checkUpdate } = useCustomRequest(API.collector.appVersion.check.fetch, {\n    manual: true,\n    onSuccess: data => {\n      if (data?.forcedUpdate === ForceUpdateEnum.\u5f3a\u5236) {\n        Modal.alert({\n          icon: (\n            <Image\n              source={require('modules/offline/assets/modal_confirm.webp')}\n              style={{ width: px(55), height: px(55), marginTop: px(36) }}\n            />\n          ),\n          title: '\u7248\u672c\u66f4\u65b0',\n          content: '\u68c0\u6d4b\u5230\u6709\u65b0\u7248\u672c\u8bf7\u7acb\u5373\u5347\u7ea7',\n          onPress: () => appUpdate(data?.downloadUrl ?? '', data?.appStoreUrl ?? '', data?.version ?? ''),\n        });\n        return;\n      }\n\n      // \u70ed\u66f4\u65b0\uff0c\u5224\u65ad\u662f\u5426\u9700\u8981\u663e\u793a\u68c0\u67e5\u66f4\u65b0\u7684\u5f39\u7a97\n      if (showMessage) {\n        checkForUpdate();\n      } else {\n        checkForUpdateWithoutMessage();\n      }\n    },\n  });\n  return { checkUpdate };\n}",lang:"code"}),a.createElement("p",null,"\u914d\u7f6e\u6587\u4ef6\uff1a",a.createElement("code",null,"android/app/src/main/AndroidManifest.xml"),"\uff0c\u5426\u5219 android apk \u4e0b\u8f7d\u5931\u8d25"),a.createElement(r.Z,{code:'...\n    \x3c!-- \u6587\u4ef6\u6743\u9650 --\x3e\n    <uses-permission android:name="android.permission.READ_EXTERNAL_STORAGE" />\n    <uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE" />\n    <uses-permission android:name="android.permission.DOWNLOAD_WITHOUT_NOTIFICATION" />\n    <uses-permission android:name="android.permission.REQUEST_INSTALL_PACKAGES" />\n    ...\n    <intent-filter>\n      <action android:name="android.intent.action.VIEW" />\n      <action android:name="android.intent.action.DOWNLOAD_COMPLETE"/> ----\x3e\u6dfb\u52a0\u8fd9\u884c\n      ...\n    </intent-filter>',lang:"code"}),a.createElement("ol",{start:5},a.createElement("li",null,"\u6dfb\u52a0 ",a.createElement("code",null,"npm scripts"))),a.createElement(r.Z,{code:'{\n  "scripts": {\n    ...\n    "codePush": "node scripts/codePush/index.js",\n    "android:staging": "yarn bundle && cd ./android && ./gradlew app:assembleReleaseStaging",\n    ...\n  },\n}',lang:"code"}),a.createElement("ol",{start:6},a.createElement("li",null,"\u5728 ",a.createElement("code",null,"App.tsx"),"\u4e2d\u4f7f\u7528")),a.createElement(r.Z,{code:"import { SafeAreaProvider } from 'react-native-safe-area-context';\nimport { NavigationContainer, DefaultTheme } from '@react-navigation/native';\nimport { hide as hideSplash } from 'react-native-bootsplash';\nimport { ThemeProvider } from '@td-design/react-native';\nimport { useMount } from '@td-design/rn-hooks';\nimport { getVersion } from 'react-native-device-info';\n\nimport { Stack } from './stacks';\nimport { authAtom } from 'atoms';\nimport { Fallback } from 'components';\nimport { lightTheme } from 'theme';\nimport { linking } from 'linking';\nimport { isSignedIn } from 'utils/auth';\nimport { useUpdateAtom } from 'jotai/utils';\nimport { useCheckUpdate } from 'hooks/useCheckUpdate';\n\nexport function App() {\n  const updateAuth = useUpdateAtom(authAtom);\n\n  const { checkUpdate } = useCheckUpdate();\n\n  useMount(() => {\n    const init = async () => {\n      // \u5224\u65ad\u7528\u6237\u662f\u5426\u5df2\u7ecf\u767b\u5f55\n      const signedIn = await isSignedIn();\n      updateAuth({ signedIn });\n    };\n\n    init().finally(async () => {\n      await hideSplash({ fade: true });\n      checkUpdate({ version: getVersion() });\n    });\n  });\n\n  return (\n    <SafeAreaProvider>\n      <ThemeProvider theme={lightTheme}>\n        <NavigationContainer linking={linking} fallback={<Fallback />} theme={DefaultTheme}>\n          <Stack />\n        </NavigationContainer>\n      </ThemeProvider>\n    </SafeAreaProvider>\n  );\n}",lang:"code"}),a.createElement("ol",{start:7},a.createElement("li",null,a.createElement("code",null,"\u53d1\u5e03\u70ed\u66f4\u65b0\uff1a\u5728\u9879\u76ee\u4e0b\u6267\u884c\u547d\u4ee4\uff1ayarn codePush \u7136\u540e\u6309\u7167\u6b65\u9aa4\u6267\u884c\u5373\u53ef"))),a.createElement("h2",{id:"4-\u5916\u94fe\u5524\u9192-app"},a.createElement(o.AnchorLink,{to:"#4-\u5916\u94fe\u5524\u9192-app","aria-hidden":"true",tabIndex:-1},a.createElement("span",{className:"icon icon-link"})),"4. \u5916\u94fe\u5524\u9192 APP")))}));n["default"]=e=>{var n=a.useContext(o.context),t=n.demos;return a.useEffect((()=>{var n;null!==e&&void 0!==e&&null!==(n=e.location)&&void 0!==n&&n.hash&&o.AnchorLink.scrollToAnchor(decodeURIComponent(e.location.hash.slice(1)))}),[]),a.createElement(l,{demos:t})}}}]);